# ページヘッダー画像編集機能（差し替え＋クロップ）

## Context

ページ画面のヘッダー画像（240px）に対して、ユーザーが画像の表示位置を調整したり差し替えたりできる機能を追加する。現在の `refresh-cw` アイコンボタンは未実装のプレースホルダー。Web版は単純な画像差し替えのみ（クロップ機能なし）なので、モバイル版で新規実装。

### 既存リソース（再利用するもの）
- `useImageUpload` (`hooks/useImageUpload.ts`): `pickImage('gallery')` + `uploadImage(asset, boardId, nodeId)` — 圧縮→R2アップロード→URL返却
- `expo-image-manipulator` (v14.0.8): `manipulateAsync(uri, [{ crop: {...} }])` でクロップ
- `react-native-gesture-handler` + `react-native-reanimated`: ピンチ＋パンジェスチャー
- `UploadProgress` (`components/ui/UploadProgress.tsx`): アップロード中のプログレス表示
- `Page.headerImage`: URLのみ保存（DB変更不要 — クロップは実画像を切り出してURL置換）

---

## 実装ステップ

### Step 1: `HeaderActions` 変更 + ポップアップメニュー

**変更**: `apps/mobile/app/(main)/page/[nodeId].tsx`

- `HeaderActions` に `onImageEdit` prop追加
- 1番目のアイコン: `refresh-cw` → `image`
- `showImageMenu` state追加
- 画像がある場合: ボトムシートメニュー表示（2択）
  - 「表示位置を調整」→ クロップモーダル
  - 「画像を差し替え」→ ギャラリーピッカー
- 画像がない場合: 直接ギャラリーを開く

### Step 2: 画像差し替え機能

**変更**: `apps/mobile/app/(main)/page/[nodeId].tsx`

- `useImageUpload` フック追加
- `handleReplaceImage`: `pickImage('gallery')` → `uploadImage()` → `savePage(nodeId, { headerImage: url })`
- `UploadProgress` コンポーネント追加
- クロップ対象ソース: `page?.headerImage || node?.src`

### Step 3: ImageCropModal 新規作成

**新規**: `apps/mobile/components/page/ImageCropModal.tsx`

```
Props: { visible, imageUri, onConfirm(croppedUri, w, h), onCancel }
```

**UIレイアウト**:
```
┌─────────────────────────────┐
│ 黒背景（フルスクリーン）      │
│         [✓緑] [✗赤]  ← 右上  │
│                              │
│  ┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄ 暗い   │
│  ┌─────────────────────┐     │
│  │  クロップ窓 (W×240) │     │  ← 固定、画面中央
│  └─────────────────────┘     │
│  ┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄ 暗い   │
│                              │
│  [画像はジェスチャーで移動/拡大] │
└─────────────────────────────┘
```

**ジェスチャー**: `Gesture.Simultaneous(Pan, Pinch)`
- `scale`, `translateX`, `translateY` を SharedValue で管理
- 境界制限: 画像がクロップ窓から外れない
- 最小スケール: クロップ窓をカバーする最小値
- `onEnd` で `withSpring` を使った補正

**初期スケール**: `Math.max(cropW / imgW, cropH / imgH)` (cover動作)

**クロップ座標計算** (確認ボタン時):
```
offsetX = (displayW/2) - translateX - (cropW/2)
offsetY = (displayH/2) - translateY - (cropH/2)
originX = offsetX / currentScale
originY = offsetY / currentScale
cropPixelW = cropW / currentScale
cropPixelH = cropH / currentScale
```

**クロップ実行**: `ImageManipulator.manipulateAsync(uri, [{ crop: { originX, originY, width, height } }])`

### Step 4: 統合

**変更**: `apps/mobile/app/(main)/page/[nodeId].tsx`

- `showCropModal` state追加
- `handleCropConfirm(croppedUri, w, h)`:
  1. 擬似`ImagePickerAsset`構成: `{ uri: croppedUri, width: w, height: h }`
  2. `uploadImage()` → R2へアップロード
  3. `savePage(nodeId, { headerImage: url })`
- `ImageCropModal` をJSXに配置

---

## 変更ファイル一覧

| ファイル | 操作 | 内容 |
|----------|------|------|
| `apps/mobile/app/(main)/page/[nodeId].tsx` | 変更 | HeaderActions改修、メニュー、差し替え、クロップ統合 |
| `apps/mobile/components/page/ImageCropModal.tsx` | 新規 | クロップモーダル (ジェスチャー+オーバーレイ+実行) |

**DB変更: なし** — `headerImage` URLフィールドにクロップ済み画像URLを保存

---

## 検証方法

1. ページ画面 → 画像アイコンタップ → メニュー表示（2択）
2. 「画像を差し替え」→ ギャラリー → 画像選択 → アップロード → ヘッダー更新
3. 「表示位置を調整」→ クロップモーダル → ピンチ/パンで画像移動 → ✓ → クロップ＆アップロード → ヘッダー更新
4. クロップモーダルで ✗ → キャンセル、変更なし
5. 画像なし時 → 直接ギャラリーを開く
6. 境界テスト: 画像がクロップ窓から外れないこと
