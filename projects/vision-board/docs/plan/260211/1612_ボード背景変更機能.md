# ボード背景変更機能 実装プラン

## Context
ボード一覧の長押しメニューに「ボードを変更」オプションを追加し、ボード背景パターンを選択できるようにする。現時点ではdefault(ダークグレー単色)とwood(木目)の2種類。ラジオボタン式UIで1つだけ選択可能、丸チェックマーク付き。

---

## 1. Supabaseマイグレーション: `background_type`カラム追加

**ファイル:** 新規 `supabase/migrations/20260211000000_add_board_background.sql`

```sql
ALTER TABLE boards ADD COLUMN IF NOT EXISTS background_type TEXT DEFAULT 'default';
```

既存の`settings` JSONBではなく専用カラムにする（クエリ・キャッシュが単純になるため）。

---

## 2. Board型にbackground_type追加

### `apps/mobile/hooks/useBoards.ts`
- `Board`インターフェースに `background_type?: string` 追加
- `loadBoards()`: selectクエリに`background_type`追加
- `boardsList`マッピングに`background_type`追加

### 新規メソッド `updateBoardBackground(boardId, backgroundType)`
- 既存の`updateBoardTitle`と同じパターン（optimistic update → Supabase sync → pending queue）
- `PendingAction` typeに `'update_background'` を追加

---

## 3. パターン画像をアセットにバンドル

- `docs/images/wood_1.webp` → `apps/mobile/assets/patterns/wood_1.webp` にコピー
- 背景パターン定義ファイル: 新規 `apps/mobile/constants/boardBackgrounds.ts`

```ts
export type BackgroundType = 'default' | 'wood';

export interface BoardBackground {
  type: BackgroundType;
  label: string;  // i18n keyで管理
  preview: any;   // require() image source (選択画面プレビュー用)
  pattern?: any;  // require() タイル用パターン画像
  color?: string; // 単色背景の場合
}

export const BOARD_BACKGROUNDS: BoardBackground[] = [
  { type: 'default', label: 'default', color: '#1a1a2e', preview: null },
  { type: 'wood', label: 'darkWood', pattern: require('../assets/patterns/wood_1.webp'), preview: require('../assets/patterns/wood_1.webp') },
];
```

---

## 4. Sidebar長押しメニューに「ボードを変更」追加

**ファイル:** `apps/mobile/components/ui/Sidebar.tsx`

### 変更点
- `SidebarProps`に `onChangeBoardBackground?: (boardId: string) => void` 追加
- `handleLongPress()`のオプション配列:
  - iOS: `[cancel, editLabel, changeBoardLabel, deleteLabel]` → destructiveButtonIndex=3, cancelButtonIndex=0
  - Android: Alert.alertに「ボードを変更」ボタン追加（editとdeleteの間）
- 選択時に`onChangeBoardBackground(board.id)`を呼ぶ

### i18n追加
- `sidebar.changeBackground`: "ボードを変更"

---

## 5. ボード背景選択モーダル画面

**ファイル:** 新規 `apps/mobile/app/(main)/board-background/[boardId].tsx`

### UI構成（スクリーンショット参照）
- ヘッダー: `< Board template`（戻るボタン + タイトル）
- 縦スクロールリスト: 各背景パターンをカード表示
  - カード: パターンのプレビュー画像（角丸16、横幅フル）
    - defaultはダークカラー+ミニノード模擬表示
    - woodはタイル画像プレビュー
  - カード右上に丸チェック: 現在選択中のものに✓表示（ラジオボタン式）
  - カード下にラベル: "default", "dark wood"
- タップで即座にbackground_type更新→モーダルクローズ

### ルーティング追加
- `apps/mobile/app/(main)/_layout.tsx` のStackに `board-background/[boardId]` をモーダルとして登録

---

## 6. BoardCanvasに背景パターン描画

**ファイル:** `apps/mobile/components/canvas/BoardCanvas.tsx`

### 変更点
- propsに `backgroundType?: string` 追加
- キャンバスの`Animated.View`内部（ノード描画の前）に背景レイヤーを追加:
  - `default`: 現状維持（`bg-gray-900`）
  - `wood`: `<Image source={require(wood_1.webp)} resizeMode="repeat" />` でタイル敷き詰め
    - React Nativeの`Image`の`resizeMode="repeat"`を使用（iOS/Android両対応）
    - キャンバス全体(9600x5400)をカバーするサイズで配置

### index.tsxからの受け渡し
- `apps/mobile/app/(main)/(tabs)/index.tsx`で`selectedBoard?.background_type`を`BoardCanvas`に渡す

---

## 修正ファイル一覧

| # | ファイル | 変更内容 |
|---|---------|---------|
| 1 | 新規: `supabase/migrations/20260211000000_add_board_background.sql` | background_typeカラム追加 |
| 2 | `apps/mobile/hooks/useBoards.ts` | Board型拡張、updateBoardBackground追加 |
| 3 | 新規: `apps/mobile/assets/patterns/wood_1.webp` | 木目パターン画像 |
| 4 | 新規: `apps/mobile/constants/boardBackgrounds.ts` | 背景パターン定義 |
| 5 | `apps/mobile/components/ui/Sidebar.tsx` | 長押しメニューに「ボードを変更」追加 |
| 6 | `apps/mobile/app/(main)/_layout.tsx` | Sidebar props追加、モーダルルート追加 |
| 7 | 新規: `apps/mobile/app/(main)/board-background/[boardId].tsx` | 背景選択モーダル画面 |
| 8 | `apps/mobile/components/canvas/BoardCanvas.tsx` | 背景パターン描画 |
| 9 | `apps/mobile/app/(main)/(tabs)/index.tsx` | backgroundType受け渡し |
| 10 | `packages/shared/src/i18n/ja.json` (+ en等) | 翻訳キー追加 |

---

## 検証方法
1. Supabaseマイグレーション適用 → boardsテーブルにbackground_typeカラム確認
2. アプリ起動 → Sidebar → ボード長押し → 「ボードを変更」表示確認
3. タップ → 背景選択モーダル表示確認（default + wood、丸チェック表示）
4. wood選択 → モーダル閉じる → キャンバスに木目パターンがタイル表示されることを確認
5. default選択 → 元のダークグレー背景に戻ることを確認
6. アプリ再起動 → 選択が保持されていることを確認
