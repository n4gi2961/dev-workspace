# Vision Board React Native 移行計画

**作成日**: 2026年01月28日
**ステータス**: Phase 1 実行中

## 概要
現在の `projects/vision-board/` をモノレポ化し、Web版を維持しつつReact Native（Expo）でモバイル版を新規作成。
共通コードを抽出し、iOS/Android同時開発を効率化する。

## 決定事項
- **配置**: 現在のvision-boardフォルダをモノレポ化
- **ターゲット**: iOS + Android 同時リリース
- **3D機能**: コア機能先行、Phase 6でSkia 2Dまたはexpo-three検討

---

## 現状分析

### 技術スタック
- **フレームワーク**: Next.js 16 + React 19 + TypeScript
- **バックエンド**: Supabase（認証、DB、Storage）
- **3D**: Three.js + Rapier（星スタック機能）
- **スタイル**: Tailwind CSS 4
- **多言語**: next-intl（5言語）

### コード共有率（参考資料より）
| レイヤー | 共有率 | 内容 |
|---------|--------|------|
| ユニバーサルコア | 100% | 型定義、定数、バリデーション、ユーティリティ |
| 状態管理・データフェッチ | 90% | Zustand/フック、Supabaseロジック（初期化部分のみ分岐） |
| インターフェース | 30-60% | UIコンポーネント、スタイリング、ナビゲーション |

---

## 推奨アーキテクチャ: モノレポ構成

```
vision-board/
├── apps/
│   ├── web/                    # Next.js（現行Web版）
│   │   ├── src/app/
│   │   ├── src/components/     # Web専用（Three.js含む）
│   │   └── next.config.ts
│   │
│   └── mobile/                 # Expo（新規RN版）
│       ├── src/app/            # expo-router
│       ├── src/components/
│       ├── metro.config.js     # ★watchFolders設定必須
│       └── app.json
│
├── packages/
│   ├── types/                  # 共有TypeScript型定義
│   ├── constants/              # 共有定数
│   ├── utils/                  # 共有ユーティリティ
│   ├── hooks/                  # プラットフォーム非依存フック
│   │   └── useClearPercent.ts
│   ├── store/                  # 状態管理（Zustand検討）
│   ├── supabase/               # Supabaseクライアント抽象化
│   │   ├── client.web.ts
│   │   ├── client.native.ts
│   │   └── storage.ts
│   ├── data-hooks/             # データフック（Storage抽象化済み）
│   │   ├── useNodes.ts
│   │   ├── usePages.ts
│   │   └── useRoutines.ts
│   └── i18n/                   # 翻訳JSON
│
├── package.json                # pnpm workspaces
├── pnpm-workspace.yaml
└── turbo.json
```

### Metro Bundler設定（重要）
モノレポでMetroを動作させるため、`metro.config.js`で以下を設定：
```javascript
const workspaceRoot = path.resolve(__dirname, '../..');
config.watchFolders = [workspaceRoot];
config.resolver.nodeModulesPaths = [
  path.resolve(projectRoot, 'node_modules'),
  path.resolve(workspaceRoot, 'node_modules'),
];
```

---

## 技術選定

### モバイル版
| 項目 | 選定 | 理由 |
|------|------|------|
| フレームワーク | **Expo SDK 52+** | New Architecture標準、OTA更新、EAS Build |
| ルーティング | **expo-router v4** | ファイルベース、ディープリンク自動化 |
| スタイル | **NativeWind v4** | Tailwind記法流用、学習コスト最小 |
| アニメーション | **Reanimated 3** | JSI経由の高パフォーマンス |
| ジェスチャー | **react-native-gesture-handler** | ドラッグ&ドロップ |
| リスト表示 | **FlashList** | FlatListの5-10倍高速（セルリサイクル） |
| 画像 | **expo-image** | BlurHash、ディスクキャッシュ、prefetch |
| ハプティクス | **expo-haptics** | タッチフィードバック |
| ストレージ | **AsyncStorage + MMKV** | 通常データ + 機密データ（暗号化） |

### Supabase RN設定（必須）
```typescript
import 'react-native-url-polyfill/auto';  // ★最上部で必須
import AsyncStorage from '@react-native-async-storage/async-storage';
import { AppState } from 'react-native';

export const supabase = createClient(URL, KEY, {
  auth: {
    storage: AsyncStorage,
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,  // ★RNでは必ずfalse
  },
});

// セッション自動更新（フォアグラウンド復帰時）
AppState.addEventListener('change', (state) => {
  if (state === 'active') supabase.auth.startAutoRefresh();
  else supabase.auth.stopAutoRefresh();
});
```

### オフラインファースト戦略（Phase 5以降）
| 選択肢 | メリット | デメリット |
|--------|---------|-----------|
| **PowerSync**（推奨） | セットアップ簡単、部分同期対応 | 有料サービス |
| **WatermelonDB** | 高速、完全制御可能 | 同期ロジック自前実装 |

→ 初期はAsyncStorageキャッシュ、後にPowerSync検討

### 3D機能（StarStack）
| Phase | 対応 |
|-------|------|
| 1-5 | モバイルでは星の累計数のみ表示（統計画面） |
| 6 | Skia 2D（安定）またはexpo-three（3D）を検討 |

---

## 開発フロー

### モノレポ化の手順
```
1. vision-board/ にapps/、packages/ ディレクトリ作成
2. packages/ に共通コード抽出（types, constants, utils, i18n）
3. apps/web/ に現行src/を移動（import pathを@packages/*に修正）
4. apps/mobile/ を `npx create-expo-app` で新規作成
5. ルートにpnpm-workspace.yaml + turbo.json追加
6. Metro Bundler設定（watchFolders）
```

### packages/mobile/ の作成方法
- `npx create-expo-app apps/mobile` で新規作成
- UIコンポーネントは Web版を「参考に」RN用に**新規実装**
- **コピペが効くのは型定義・ビジネスロジックのみ**
- div→View、span→Text、flexDirection: 'row'明示など変換必要

### Web開発者が陥りやすいミス
| ミス | 対策 |
|------|------|
| Flexboxデフォルトがrow | RNはcolumnがデフォルト。明示的に`flexDirection: 'row'` |
| CSSの継承 | RNでは親のstyleは子に継承されない。各Textに明示 |
| vh/vw単位 | `useWindowDimensions()`を使用 |
| localStorage同期API | AsyncStorageは非同期。`await`必須 |

### 新機能追加時のフロー
```
1. packages/types/ に型定義追加
2. packages/hooks/ or packages/data-hooks/ にロジック追加
3. apps/web/ でWeb版実装・動作確認
4. apps/mobile/ でRN版実装・動作確認
```

---

## 移行ステップ

### Phase 1: モノレポ基盤構築
**目標**: 現在のWeb版を動かしたままモノレポ化

- [ ] pnpm workspaces + Turborepo設定
- [ ] `packages/` に共通コード抽出
  - types/, constants/, utils/, i18n/
  - hooks/useClearPercent
- [ ] `apps/web/` に現行Web版を移動
- [ ] import path修正（@packages/*）
- [ ] ビルド・動作確認

### Phase 2: データ層の抽象化
**目標**: フックをプラットフォーム非依存に

- [ ] `packages/supabase/` 作成
  - client.web.ts（localStorage）
  - client.native.ts（AsyncStorage + url-polyfill）
- [ ] `packages/data-hooks/` 作成
  - IStorage インターフェース定義
  - useNodes, usePages, useRoutines を抽象化
- [ ] Web版での動作確認

### Phase 3: Mobile基盤構築
**目標**: 最小限のMobile版が動作

- [ ] Expo SDK 52+ セットアップ
- [ ] expo-router設定
- [ ] Metro Bundler設定（watchFolders）
- [ ] NativeWind + Reanimated設定
- [ ] Supabase Auth連携
  - カスタムURLスキーム設定（app.json: scheme）
  - OAuthディープリンク対応
- [ ] ボード一覧画面
- [ ] 翻訳（react-i18next）対応

### Phase 4: コア機能実装
**目標**: ビジョンボードの基本操作

- [ ] ボードキャンバス（GestureDetector + Reanimated）
  - ピンチズーム、パン操作
- [ ] DraggableImageNode（ジェスチャー版）
- [ ] DraggableTextNode
- [ ] 画像追加（expo-image-picker + Storage）
- [ ] FlashListでノード一覧
- [ ] ノードリサイズ

### Phase 5: ルーティン・マイルストーン
**目標**: 習慣追跡機能

- [ ] PageEditor モーダル
- [ ] ルーティンチェック + ハプティクス（expo-haptics）
- [ ] マイルストーン管理
- [ ] clearPercent表示
- [ ] オフラインキャッシュ強化

### Phase 6: リリース準備
**目標**: ストア申請

- [ ] StarStack対応（Skia 2D or expo-three）
- [ ] iOSプライバシーマニフェスト設定（app.json: ios.privacyManifests）
- [ ] Androidデータセーフティフォーム申告
- [ ] Androidプレディクティブバック対応
- [ ] エラーハンドリング・Sentry
- [ ] アプリアイコン・スプラッシュ
- [ ] TestFlight / 内部テスト
- [ ] アカウント削除機能（Apple必須）
- [ ] App Store / Google Play 申請

---

## 主要変更ファイル

### 共通化対象
| 現在 | 移動先 |
|------|--------|
| `src/constants/types.ts` | `packages/types/` |
| `src/constants/styles.ts` | `packages/constants/` |
| `src/lib/utils.ts` | `packages/utils/` |
| `src/lib/pageMapper.ts` | `packages/utils/` |
| `src/lib/nodeMapper.ts` | `packages/utils/` |
| `src/hooks/useClearPercent.ts` | `packages/hooks/` |
| `src/lang/*.json` | `packages/i18n/` |
| `src/hooks/useNodes.ts` | `packages/data-hooks/` |
| `src/hooks/usePages.ts` | `packages/data-hooks/` |
| `src/hooks/useRoutines.ts` | `packages/data-hooks/` |

### Web版で維持（移動のみ）
- `src/components/features/star-stacking/*` → `apps/web/src/components/`
- `src/app/*` → `apps/web/src/app/`

### 新規作成（Mobile）
- `apps/mobile/src/app/` - expo-routerページ
- `apps/mobile/src/components/features/DraggableImageNode.tsx`
- `apps/mobile/src/components/features/DraggableTextNode.tsx`
- `apps/mobile/src/components/features/PageEditor.tsx`

---

## 推奨ライブラリ一覧

| 用途 | ライブラリ |
|------|-----------|
| 画像表示 | expo-image |
| リスト表示 | @shopify/flash-list v2 |
| ジェスチャー | react-native-gesture-handler 2.X |
| アニメーション | react-native-reanimated 3.X |
| アイコン | lucide-react-native |
 |縦スワイプ | react-native-pager-view |
| ハプティクス | expo-haptics |
| ストレージ（通常） | @react-native-async-storage/async-storage |
| ストレージ（機密） | react-native-mmkv |
| スタイリング | NativeWind v4 |
| E2Eテスト | Maestro |
| デバッグ | Reactotron |

---

## 検証方法

### Phase 1完了時
```bash
cd apps/web && pnpm dev  # Web版が正常動作
pnpm build               # 全パッケージビルド成功
```

### Phase 3完了時
```bash
cd apps/mobile && npx expo start
# iOS/Androidシミュレータでログイン可能
```

### Phase 4完了時
- ボード表示・ズーム・パン動作
- 画像追加・ドラッグ・リサイズ動作
- Supabaseへのデータ永続化確認

### 最終検証
- 物理デバイスでテスト（シミュレータのみ不可）
- オフライン時の動作（キャッシュ）
- 両プラットフォームでのデータ同期
- パフォーマンス（60fps維持）
- TestFlight / 内部テストで検証

---

## ストア申請チェックリスト

### iOS
- [ ] プライバシーマニフェスト（PrivacyInfo.xcprivacy）
- [ ] アカウント削除機能
- [ ] プライバシーポリシーURL
- [ ] 審査用デモアカウント

### Android
- [ ] データセーフティフォーム申告
- [ ] プレディクティブバック対応
- [ ] プライバシーポリシーURL

---

## 参考資料
- ClaDR_React → React Native (Expo) 移行完全ガイド
- GenDR_React Nativeを用いたウェブアーキテクチャからモバイルネイティブエコシステムへの転換
