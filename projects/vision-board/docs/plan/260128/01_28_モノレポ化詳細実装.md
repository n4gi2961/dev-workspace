# モノレポ化 詳細実装計画

**作成日**: 2026年01月28日
**最終更新**: 2026年01月29日
**ステータス**: Phase 1-6 完了、Phase 7 実装中

## 進捗サマリー

| Phase | 内容 | 状態 |
|-------|------|------|
| 1 | ルート設定ファイル作成 | ✅ 完了 |
| 2 | packages/shared 作成 | ✅ 完了 |
| 3 | packages/supabase 作成 | ✅ 完了 |
| 4 | apps/web 移動 | ✅ 完了 |
| 5 | インポートパス書き換え | ✅ 完了 |
| 6 | 動作確認 | ✅ 完了 |
| 7 | Mobile版基盤構築 | ✅ 完了 |
| 7.1 | 認証・一覧・詳細・ルーティン画面 | ✅ 完了 |
| 7.2 | i18n・ダークモード・オフライン | ✅ 完了 |
| 7.3 | ボード編集機能（作成・削除・名前編集） | ✅ 完了 |
| 8 | 画像・ノード追加機能 | ⏳ 未着手 |
| 9 | 本番ビルド・配布 | ⏳ 未着手 |

## 概要
vision-boardプロジェクトをモノレポ構成に変換し、Web版を維持しつつMobile版追加の基盤を構築する。
**依存関係とインポートのトラブルを防ぐ**ことを最優先とする。

---

## 現状分析（調査結果）

### インポート構造
- **@/エイリアス使用率**: 100%（相対パスなし）
- **循環参照**: なし（安全）
- **import文総数**: 244行
- **ESLint無効化箇所**: 26箇所

### 依存関係の階層
```
[最下層] constants/ ─────────────────┐
              ↓                      │
[中間層] lib/utils, lib/messages     │
              ↓                      │
[上位層] lib/pageMapper, nodeMapper  │── プラットフォーム非依存
              ↓                      │
[データ層] hooks/useNodes等          │
              ↓                      │
[計算層] hooks/useClearPercent ──────┘
              ↓
[UI層] components/ui/* ──────────────── 一部共有可能
              ↓
[機能層] components/features/* ──────── Web専用
              ↓
[ページ層] app/* ────────────────────── Next.js専用
```

### リスク分類

| リスク | 項目 | 対策 |
|--------|------|------|
| 低 | インポートパス変更 | tsconfig.json paths 更新のみ |
| 低 | 型定義移動 | 相対パス不使用のため安全 |
| 中 | Supabase Client 14箇所 | 抽象化レイヤー追加 |
| 中 | 環境変数 | config モジュール作成 |
| 高 | next-intl 21箇所 | Web専用として維持 |
| 高 | vision-board.tsx 1100行 | 分割は後回し |

---

## 最終ディレクトリ構成

```
vision-board/
├── apps/
│   └── web/                          # Next.js Web版
│       ├── src/
│       │   ├── app/                  # ページ・ルート
│       │   ├── components/           # Web専用コンポーネント
│       │   │   ├── features/         # 機能コンポーネント
│       │   │   └── ui/               # Web専用UI
│       │   ├── hooks/                # Web専用フック
│       │   │   └── useStarStack.ts   # Three.js依存
│       │   └── middleware.ts
│       ├── public/
│       ├── next.config.ts
│       ├── tailwind.config.ts
│       ├── tsconfig.json
│       └── package.json
│
├── packages/
│   ├── shared/                       # 共有コード（単一パッケージ）
│   │   ├── src/
│   │   │   ├── constants/            # 定数
│   │   │   │   ├── board.ts
│   │   │   │   ├── styles.ts
│   │   │   │   ├── types.ts
│   │   │   │   ├── ui.ts
│   │   │   │   └── index.ts
│   │   │   ├── lib/                  # ユーティリティ
│   │   │   │   ├── utils.ts
│   │   │   │   ├── messages.ts
│   │   │   │   ├── pageMapper.ts
│   │   │   │   ├── nodeMapper.ts
│   │   │   │   ├── initialData.ts
│   │   │   │   └── index.ts
│   │   │   ├── hooks/                # プラットフォーム非依存フック
│   │   │   │   ├── useClearPercent.ts
│   │   │   │   ├── useBlurRipple.ts
│   │   │   │   ├── useMeteorAnimation.ts
│   │   │   │   ├── usePopAnimation.ts
│   │   │   │   ├── useMediaQuery.ts
│   │   │   │   └── index.ts
│   │   │   ├── i18n/                 # 翻訳ファイル
│   │   │   │   ├── en.json
│   │   │   │   ├── ja.json
│   │   │   │   ├── ko.json
│   │   │   │   ├── es.json
│   │   │   │   ├── zh-CN.json
│   │   │   │   └── index.ts
│   │   │   └── index.ts              # メインエクスポート
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   └── supabase/                     # Supabase抽象化レイヤー
│       ├── src/
│       │   ├── client.ts             # 共通インターフェース
│       │   ├── client.web.ts         # Web用実装
│       │   ├── client.native.ts      # RN用実装（後で追加）
│       │   ├── storage.ts            # Storage操作
│       │   ├── hooks/                # データフック
│       │   │   ├── useAuth.ts
│       │   │   ├── useNodes.ts
│       │   │   ├── usePages.ts
│       │   │   ├── useRoutines.ts
│       │   │   └── index.ts
│       │   └── index.ts
│       ├── package.json
│       └── tsconfig.json
│
├── package.json                      # ルート（workspaces設定）
├── pnpm-workspace.yaml
├── turbo.json
└── tsconfig.base.json                # 共通TypeScript設定
```

---

## 実装ステップ（依存関係順）

### Step 1: ルート設定ファイル作成
**目的**: ワークスペース基盤を構築

```bash
# 作成するファイル
├── package.json          # workspaces定義
├── pnpm-workspace.yaml   # pnpm設定
├── turbo.json            # Turborepo設定
└── tsconfig.base.json    # 共通TS設定
```

**package.json（ルート）**:
```json
{
  "name": "vision-board-monorepo",
  "private": true,
  "workspaces": ["apps/*", "packages/*"],
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "dev:web": "turbo run dev --filter=@vision-board/web",
    "build:web": "turbo run build --filter=@vision-board/web"
  },
  "devDependencies": {
    "turbo": "^2.0.0",
    "typescript": "^5"
  }
}
```

**pnpm-workspace.yaml**:
```yaml
packages:
  - "apps/*"
  - "packages/*"
```

**turbo.json**:
```json
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```

**tsconfig.base.json**:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["dom", "dom.iterable", "esnext"],
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "skipLibCheck": true
  }
}
```

---

### Step 2: packages/shared 作成
**目的**: 最下層の共有コードを先に移動（依存される側を先に）

**移動対象（依存関係順）**:
```
1. constants/     ← 依存なし（最初に移動）
2. lib/utils.ts   ← constants/のみ依存
3. lib/messages.ts← constants/のみ依存
4. lib/pageMapper.ts ← 型定義のみ
5. lib/nodeMapper.ts ← 型定義のみ
6. lib/initialData.ts← constants/のみ依存
7. hooks/useClearPercent.ts ← pageMapper, utils
8. hooks/useBlurRipple.ts   ← 依存なし
9. hooks/useMeteorAnimation.ts ← 依存なし
10. hooks/usePopAnimation.ts   ← 依存なし
11. hooks/useMediaQuery.ts     ← 依存なし
12. i18n/*.json   ← 依存なし
```

**packages/shared/package.json**:
```json
{
  "name": "@vision-board/shared",
  "version": "0.0.1",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts",
    "./constants": "./src/constants/index.ts",
    "./lib": "./src/lib/index.ts",
    "./hooks": "./src/hooks/index.ts",
    "./i18n": "./src/i18n/index.ts"
  }
}
```

**packages/shared/tsconfig.json**:
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*"]
}
```

---

### Step 3: packages/supabase 作成
**目的**: Supabase依存コードを集約（14箇所の分散参照を解消）

**移動対象**:
```
1. lib/supabase/client.ts  → client.web.ts
2. lib/supabase/server.ts  → server.ts（Web専用として維持）
3. lib/supabase/storage.ts → storage.ts
4. hooks/useAuth.ts
5. hooks/useNodes.ts
6. hooks/usePages.ts
7. hooks/useRoutines.ts
```

**packages/supabase/package.json**:
```json
{
  "name": "@vision-board/supabase",
  "version": "0.0.1",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": "./src/index.ts",
    "./client": "./src/client.ts",
    "./hooks": "./src/hooks/index.ts"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.89.0",
    "@vision-board/shared": "workspace:*"
  },
  "peerDependencies": {
    "react": "^19.0.0"
  }
}
```

**重要: Storage抽象化インターフェース**:
```typescript
// packages/supabase/src/storage/interface.ts
export interface IStorage {
  getItem(key: string): string | null | Promise<string | null>;
  setItem(key: string, value: string): void | Promise<void>;
  removeItem(key: string): void | Promise<void>;
}

// packages/supabase/src/storage/localStorage.ts
export const webStorage: IStorage = {
  getItem: (key) => localStorage.getItem(key),
  setItem: (key, value) => localStorage.setItem(key, value),
  removeItem: (key) => localStorage.removeItem(key),
};
```

---

### Step 4: apps/web 作成・移動
**目的**: 現行Web版を apps/web に移動

**移動対象**:
```
src/app/           → apps/web/src/app/
src/components/    → apps/web/src/components/
src/hooks/useStarStack.ts → apps/web/src/hooks/
src/middleware.ts  → apps/web/src/middleware.ts
src/i18n/          → apps/web/src/i18n/ (設定ファイルのみ)
public/            → apps/web/public/
next.config.ts     → apps/web/next.config.ts
tailwind.config.ts → apps/web/tailwind.config.ts
postcss.config.mjs → apps/web/postcss.config.mjs
eslint.config.mjs  → apps/web/eslint.config.mjs
```

**apps/web/package.json**:
```json
{
  "name": "@vision-board/web",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@vision-board/shared": "workspace:*",
    "@vision-board/supabase": "workspace:*",
    "@supabase/ssr": "^0.8.0",
    "@react-three/drei": "^10.7.7",
    "@react-three/fiber": "^9.5.0",
    "@react-three/rapier": "^2.2.0",
    "lucide-react": "^0.562.0",
    "modern-screenshot": "^4.6.7",
    "next": "16.1.1",
    "next-intl": "^4.7.0",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "three": "^0.182.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@types/three": "^0.182.0",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
```

**apps/web/tsconfig.json**:
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@vision-board/shared": ["../../packages/shared/src"],
      "@vision-board/shared/*": ["../../packages/shared/src/*"],
      "@vision-board/supabase": ["../../packages/supabase/src"],
      "@vision-board/supabase/*": ["../../packages/supabase/src/*"]
    },
    "plugins": [{ "name": "next" }]
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

---

### Step 5: インポートパス書き換え
**目的**: @/ → @vision-board/* に変更

**書き換えルール**:
```
# shared パッケージ
@/constants/* → @vision-board/shared/constants
@/lib/utils   → @vision-board/shared/lib
@/lib/pageMapper → @vision-board/shared/lib
@/lib/nodeMapper → @vision-board/shared/lib
@/lib/messages → @vision-board/shared/lib
@/lib/initialData → @vision-board/shared/lib
@/hooks/useClearPercent → @vision-board/shared/hooks
@/hooks/useBlurRipple → @vision-board/shared/hooks
@/hooks/useMeteorAnimation → @vision-board/shared/hooks
@/hooks/usePopAnimation → @vision-board/shared/hooks
@/hooks/useMediaQuery → @vision-board/shared/hooks

# supabase パッケージ
@/lib/supabase/client → @vision-board/supabase/client
@/lib/supabase/storage → @vision-board/supabase
@/hooks/useAuth → @vision-board/supabase/hooks
@/hooks/useNodes → @vision-board/supabase/hooks
@/hooks/usePages → @vision-board/supabase/hooks
@/hooks/useRoutines → @vision-board/supabase/hooks

# Web専用（そのまま @/）
@/components/* → @/components/*
@/app/* → @/app/*
@/hooks/useStarStack → @/hooks/useStarStack
```

**影響ファイル数**: 約40ファイル

---

### Step 6: 動作確認

```bash
# 1. 依存関係インストール
pnpm install

# 2. packages ビルド確認
pnpm --filter @vision-board/shared build
pnpm --filter @vision-board/supabase build

# 3. Web版 開発サーバー起動
pnpm dev:web

# 4. Web版 ビルド確認
pnpm build:web
```

**確認項目**:
- [x] ログイン/サインアップ画面が表示される
- [x] ボード一覧が表示される
- [x] ボード編集画面でノード操作ができる
- [x] ルーティンチェックが動作する
- [x] StarStackが表示される
- [x] 言語切り替えが動作する

---

## トラブル防止チェックリスト

### インポートエラー防止
- [x] packages/shared を先に作成（依存される側）
- [x] packages/supabase は shared に依存させる
- [x] apps/web は両パッケージに依存させる
- [x] 各パッケージの `exports` を正しく設定
- [x] tsconfig.json の `paths` を正しく設定

### 型エラー防止
- [x] 型定義は packages/shared に集約
- [x] `export type` を使用して型をエクスポート
- [x] 各パッケージの index.ts でre-export

### ビルドエラー防止
- [x] `"private": true` をすべてのpackage.jsonに設定
- [x] `workspace:*` で内部依存を指定
- [x] turbo.json の dependsOn で順序を保証

### 環境変数
- [x] .env はルートに配置
- [x] apps/web から `../../.env` を参照する設定

---

## 実行順序まとめ

```
1. [ルート設定] package.json, pnpm-workspace.yaml, turbo.json, tsconfig.base.json
       ↓
2. [packages/shared] constants/ → lib/ → hooks/ → i18n/ の順で移動
       ↓
3. [packages/supabase] client → storage → hooks の順で移動
       ↓
4. [apps/web] 残りのファイルを移動
       ↓
5. [インポート書き換え] sed/手動で一括置換
       ↓
6. [依存関係インストール] pnpm install
       ↓
7. [動作確認] pnpm dev:web
```

---

## 主要ファイルパス

### 移動元 → 移動先

| 移動元 | 移動先 | 優先度 |
|--------|--------|--------|
| `src/constants/*` | `packages/shared/src/constants/` | 1 |
| `src/lib/utils.ts` | `packages/shared/src/lib/` | 2 |
| `src/lib/messages.ts` | `packages/shared/src/lib/` | 2 |
| `src/lib/pageMapper.ts` | `packages/shared/src/lib/` | 3 |
| `src/lib/nodeMapper.ts` | `packages/shared/src/lib/` | 3 |
| `src/lib/initialData.ts` | `packages/shared/src/lib/` | 3 |
| `src/hooks/useClearPercent.ts` | `packages/shared/src/hooks/` | 4 |
| `src/hooks/useBlurRipple.ts` | `packages/shared/src/hooks/` | 4 |
| `src/hooks/useMeteorAnimation.ts` | `packages/shared/src/hooks/` | 4 |
| `src/hooks/usePopAnimation.ts` | `packages/shared/src/hooks/` | 4 |
| `src/hooks/useMediaQuery.ts` | `packages/shared/src/hooks/` | 4 |
| `src/lang/*.json` | `packages/shared/src/i18n/` | 5 |
| `src/lib/supabase/client.ts` | `packages/supabase/src/client.web.ts` | 6 |
| `src/lib/supabase/storage.ts` | `packages/supabase/src/storage.ts` | 6 |
| `src/hooks/useAuth.ts` | `packages/supabase/src/hooks/` | 7 |
| `src/hooks/useNodes.ts` | `packages/supabase/src/hooks/` | 7 |
| `src/hooks/usePages.ts` | `packages/supabase/src/hooks/` | 7 |
| `src/hooks/useRoutines.ts` | `packages/supabase/src/hooks/` | 7 |
| `src/app/*` | `apps/web/src/app/` | 8 |
| `src/components/*` | `apps/web/src/components/` | 8 |
| `src/hooks/useStarStack.ts` | `apps/web/src/hooks/` | 8 |
| `src/middleware.ts` | `apps/web/src/middleware.ts` | 8 |

---

## 検証コマンド

```bash
# Step 1後
ls package.json pnpm-workspace.yaml turbo.json tsconfig.base.json

# Step 2後
ls packages/shared/src/constants/
ls packages/shared/src/lib/
ls packages/shared/src/hooks/
ls packages/shared/src/i18n/

# Step 3後
ls packages/supabase/src/
ls packages/supabase/src/hooks/

# Step 4後
ls apps/web/src/app/
ls apps/web/src/components/

# Step 5後
grep -r "@vision-board/shared" apps/web/src/ | head -5

# Step 6
pnpm install && pnpm dev:web
```

---

## Phase 7: Mobile版実装（追加）

### 完了した機能

#### 7.1 基本画面実装
- [x] 認証画面（ログイン・サインアップ）
- [x] ボード一覧画面
- [x] ボード詳細画面（キャンバス表示）
- [ ] ルーティン画面

#### 7.2 UX向上
- [x] 多言語対応（i18n: en, ja, ko, es, zh-CN）
- [x] ダークモード対応
- [x] オフラインキャッシュ対応
- [x] ネットワーク状態監視（NetInfo）

#### 7.3 ボード編集機能
- [x] ボード作成（+ボタン）
- [x] ボード削除（スワイプ削除 + 確認ダイアログ）
- [x] ボード名編集（タップで編集モード）
- [x] Haptic フィードバック

### 技術スタック（Mobile）
- Expo SDK 54 + expo-router
- NativeWind v4 (Tailwind CSS for RN)
- @shopify/flash-list (高速リスト)
- react-native-gesture-handler (スワイプ)
- react-native-reanimated (アニメーション)
- expo-haptics (振動フィードバック)

### 作成ファイル（Mobile）
```
apps/mobile/
├── app/
│   ├── _layout.tsx
│   ├── (tabs)/
│   │   ├── index.tsx        # ボード一覧
│   │   ├── routines.tsx     # ルーティン
│   │   └── settings.tsx     # 設定
│   ├── board/[id].tsx       # ボード詳細
│   └── (auth)/
│       ├── login.tsx
│       └── signup.tsx
├── components/
│   ├── SwipeableRow.tsx     # スワイプ削除
│   └── EditableTitleHeader.tsx # タイトル編集
├── contexts/
│   ├── i18n.tsx             # 多言語対応
│   └── theme.tsx            # テーマ管理
└── hooks/
    ├── useAuth.ts
    ├── useBoards.ts         # CRUD + オフライン
    └── useRoutines.ts       # オフライン対応
```

### 解決した問題
- DBスキーマとの列名不一致（`title` vs `name`）
- nodes が別テーブルである点の対応
- Metro bundler での JSON インポート問題（require使用）
- RLS ポリシーエラーへの対応（try-catch + upsert）
