# Vision Board RN モバイルアプリ実装計画

## Context

Vision Board アプリはExpo + React Nativeでモバイル版を開発中。Web版（Next.js）からの移行が進行中で、認証・ボード管理・ルーティンの基盤は実装済み。`.pen`ファイルには26画面+24再利用可能コンポーネントの包括的なUI設計がある。

**画像ストレージにCloudflare R2を導入予定。** 現在はSupabase Storage（`packages/supabase/src/storage.ts`）を使用しているが、R2に移行することでエグレス無料・グローバルCDN配信・コスト最適化を実現する。

**本計画の目的:** 初学者がセキュリティ・パフォーマンス・コード品質を維持しながら、R2ストレージを含む段階的なMVP完成ロードマップ。

---

## 1. UI設計の評価結果: 開発に進んでよい

`.pen`のUI設計はRN開発に**十分な網羅率**がある。以下を補足すれば完全：

| 不足 | 重要度 | 対応 |
|------|--------|------|
| パスワードリセット画面 | 高 | Phase 0で追加 |
| エラー/オフライン表示 | 高 | コード側で汎用EmptyState作成 |
| 画像ピッカー/クロッパー | 中 | expo標準UIで代替 |
| Alert/確認ダイアログ | 中 | RNのAlert APIで代替 |
| アカウント削除画面 | 高(Apple要件) | Phase 5で追加 |

**注意点:** タブ名が`.pen`では「Focus」だがコードでは「Ambient」→ 統一が必要。

---

## 2. Cloudflare R2 ストレージアーキテクチャ

### なぜR2か
- **エグレス無料**: 画像配信コストゼロ（Supabase Storageは帯域課金）
- **グローバルCDN**: Cloudflareネットワーク経由で世界中から高速配信
- **S3互換API**: 既存ツール・ライブラリがそのまま使える
- **コスト**: 10GB無料、以降 $0.015/GB/月（Supabase Storageより安価）

### アーキテクチャ

```
┌─────────────┐     JWT認証      ┌──────────────────┐      S3 API       ┌─────────┐
│  Mobile App  │ ──────────────→ │ Cloudflare Worker │ ──────────────→ │    R2    │
│  (Expo)      │ ←── presigned  │ (認証 + URL発行)   │                  │  Bucket  │
│              │      URL        └──────────────────┘                  └─────────┘
│              │ ─── direct upload (presigned URL) ──────────────────→ │    R2    │
│              │ ←── public CDN URL ──────────────────────────────────│  (読取)   │
└─────────────┘                                                       └─────────┘
```

**フロー:**
1. モバイルアプリ → Cloudflare Worker に「アップロードしたい」リクエスト（Supabase JWTヘッダー付き）
2. Worker がJWTを検証（Supabase JWT secretで署名確認）
3. Worker がR2の**Presigned URL**を生成してモバイルに返す
4. モバイルアプリが**Presigned URLに直接アップロード**（Worker経由しないので高速）
5. アップロード完了後、公開CDN URLをSupabase DBのnodesテーブルに保存

**Presigned URL方式を選ぶ理由:**
- 大きい画像ファイルがWorkerを経由しない（Workerのメモリ/タイムアウト制限回避）
- アップロード速度が速い（R2に直接）
- Workerは軽量な認証+URL生成のみ（無料プランで十分）

### モノレポへの追加

```
vision-board/
├── apps/
│   ├── mobile/              # Expo RNアプリ
│   ├── web/                 # Next.js Webアプリ
│   └── worker/              # ★ 新規: Cloudflare Worker (R2 API)
│       ├── wrangler.toml    # Cloudflare設定
│       ├── src/
│       │   └── index.ts     # Worker エントリーポイント
│       ├── package.json
│       └── tsconfig.json
├── packages/
│   ├── shared/
│   │   └── src/lib/
│   │       └── storage.ts   # ★ 新規: プラットフォーム共通ストレージインターフェース
│   └── supabase/
│       └── src/storage.ts   # 既存 → R2対応に書き換え
```

### Worker の実装概要 (`apps/worker/src/index.ts`)

```
エンドポイント:
  POST /upload/presign
    - Header: Authorization: Bearer <supabase_jwt>
    - Body: { userId, boardId, fileName, contentType }
    - Response: { presignedUrl, publicUrl, key }
    - JWTからuserIdを検証し、パス `{userId}/{boardId}/{timestamp}-{random}.{ext}` を生成

  DELETE /images/:key
    - Header: Authorization: Bearer <supabase_jwt>
    - JWTのuserIdとkeyのプレフィックスを照合して認可

JWT検証:
  - Supabase JWT secretを使って署名を検証
  - expクレームの有効期限チェック
  - subクレームからuserIdを取得
```

### 環境変数

**Worker側 (wrangler.toml secrets):**
- `SUPABASE_JWT_SECRET` - JWT検証用（Supabaseダッシュボードから取得）

**Worker側 (wrangler.toml bindings):**
- `BOARD_IMAGES` - R2 bucket binding

**モバイル側 (.env.local):**
- `EXPO_PUBLIC_WORKER_URL` - Worker のURL（例: `https://r2-api.asterize.workers.dev`）

### セキュリティ考慮事項

| 脅威 | 対策 |
|------|------|
| 不正アップロード | JWT検証 + userId照合（自分のパスにのみアップロード可能） |
| Presigned URL漏洩 | 有効期限5分、PUT専用（読み取り不可） |
| 大量アップロード攻撃 | ファイルサイズ制限(10MB)、レート制限(Worker側) |
| 不正削除 | JWT userId とパスプレフィックスの照合 |
| R2直接アクセス | パブリック読み取りはカスタムドメイン経由のみ |

---

## 3. 実装フェーズ

### Phase 0: 基盤整備 + R2セットアップ

**セキュリティ対応（最優先）:**

1. **認証トークンの暗号化保存**
   - `expo-secure-store` を導入
   - `apps/mobile/lib/secureStorage.ts` を新規作成（IStorageインターフェース実装）
   - `_layout.tsx` の `setStorageAdapter(AsyncStorage)` を SecureStore版に差し替え

2. **環境変数の安全管理**
   - `.gitignore` に `.env*` パターン確認
   - `SUPABASE_SERVICE_ROLE_KEY` がモバイルに含まれない確認

3. **入力バリデーション強化**
   - `packages/shared/src/lib/validation.ts` 新規作成
   - メールフォーマット・パスワード強度・文字列長・画像ファイル検証

**アプリ基盤:**

4. **`app.json` 更新**
   - `newArchEnabled: true`
   - `scheme: "asterize"`
   - `ios.bundleIdentifier` / `android.package` 追加

5. **AuthContext化**
   - `contexts/auth.tsx` 新規作成、`_layout.tsx` でProviderラップ
   - `useAuth()` を Context ベースに書き換え

6. **import パス整理**
   - `tsconfig.json` にパスエイリアス追加
   - ワークスペースパッケージとして正しく解決

**R2 ストレージ基盤:**

7. **Cloudflare R2 バケット作成**
   - Cloudflareダッシュボードまたは `wrangler` CLIでバケット作成
   - カスタムドメイン設定（公開読み取り用）

8. **Cloudflare Worker プロジェクト作成**
   - `apps/worker/` ディレクトリ作成
   - `wrangler.toml` にR2 binding設定
   - JWT検証 + Presigned URL生成の実装
   - 画像削除エンドポイント実装
   - ローカル開発: `wrangler dev` で動作確認

9. **共有ストレージインターフェース**
   - `packages/shared/src/lib/storage.ts` に抽象インターフェース定義
   - `uploadImage(file, userId, boardId)` → `{ publicUrl, key }`
   - `deleteImage(key, userId)` → `void`
   - `isR2Url(url)` → `boolean`

**対象ファイル:**
- `apps/mobile/app/_layout.tsx` (AuthContext統合, SecureStore差し替え)
- `apps/mobile/app.json` (設定更新)
- `apps/mobile/tsconfig.json` (パスエイリアス)
- `apps/mobile/hooks/useAuth.ts` → `apps/mobile/contexts/auth.tsx` に移行
- 新規: `apps/mobile/lib/secureStorage.ts`
- 新規: `packages/shared/src/lib/validation.ts`
- 新規: `apps/worker/` (Cloudflare Worker プロジェクト一式)
- 新規: `packages/shared/src/lib/storage.ts` (共有インターフェース)
- 変更: `packages/supabase/src/storage.ts` (R2対応に書き換え)

---

### Phase 1: キャンバス機能完成（R2統合含む）

**画像アップロード（R2経由）:**

1. **モバイル版画像アップロード実装**
   - `expo-image-picker` でカメラ/ギャラリー選択
   - `expo-image-manipulator` でリサイズ(max 1920px) + 圧縮
   - Worker API呼び出し: JWT付きで `/upload/presign` → Presigned URL取得
   - Presigned URLにPUTリクエストで直接アップロード
   - 返却された公開URLをSupabase DBに保存
   - 新規: `apps/mobile/lib/imageUpload.ts`（R2 Presigned URL方式）
   - 新規: `apps/mobile/hooks/useImagePicker.ts`

2. **画像オフラインキュー**
   - オフライン時: 画像をローカル（FileSystem.documentDirectory）に一時保存
   - オンライン復帰時: キューから順にR2へアップロード
   - ノードにはローカルURIを一時表示 → アップロード完了後にR2 URLに差し替え

**キャンバス機能:**

3. **FABメニュー** (.pen: `nI3ee`, `mu0ET`)
   - Reanimated でFAB展開アニメーション
   - 「画像追加」「テキスト追加」メニュー項目

4. **ノードのドラッグ&リサイズ**
   - `react-native-gesture-handler` の `PanGesture` でノード移動
   - リサイズハンドル、z-index管理
   - 新規: `components/canvas/CanvasNode.tsx`, `ImageNode.tsx`, `TextNode.tsx`

5. **ノード編集ポップアップ**
   - Image Node Editor (.pen: `aNqAv`)
   - Text Editor (.pen: `83dL2`)

6. **useNodesフック**
   - `hooks/useBoards.ts` のオフラインパターンを踏襲
   - AsyncStorageキャッシュ + ペンディングキュー

**対象ファイル:**
- `components/canvas/BoardCanvas.tsx` (大幅拡張)
- 新規: `components/canvas/CanvasNode.tsx`, `ImageNode.tsx`, `TextNode.tsx`
- 新規: `components/canvas/FABMenu.tsx`
- 新規: `components/canvas/ImageEditor.tsx`, `TextEditor.tsx`
- 新規: `hooks/useNodes.ts`, `hooks/useImagePicker.ts`
- 新規: `apps/mobile/lib/imageUpload.ts` (R2 Presigned URL方式)

---

### Phase 2: フォーカスモード + 彩度変化

1. **タブ名統一**: `ambient.tsx` → `focus.tsx` にリネーム
2. **フォーカスカード**: FlashList + pagingEnabled で画像1枚ずつ縦スクロール
3. **彩度変化システム**: Reanimated の `ColorMatrix` / expo-image の `tintColor` でモノクロ↔カラー
4. **ルーティンチェックパネル**: 画像下部にルーティン一覧、チェックで彩度変化トリガー
5. **波紋エフェクト強化**: .penのRipple Effect参照、低確率で流星エフェクト

**対象ファイル:**
- `app/(main)/(tabs)/ambient.tsx` → `focus.tsx` にリネーム
- `app/(main)/(tabs)/_layout.tsx` (タブ名変更)
- 新規: `components/focus/FocusCard.tsx`, `SaturationImage.tsx`, `RoutinePanel.tsx`

---

### Phase 3: Star Stack + ルーティン管理

1. **Star Stack**: 2Dアニメーションで星が瓶に落下・蓄積（Reanimated）
2. **ルーティン編集画面**: 作成/編集/削除、曜日設定、色選択
3. **カレンダー表示**: 月間カレンダー + ルーティン完了ヒートマップ
4. **マイルストーン**: 進捗表示、サブタスク管理

---

### Phase 4: オンボーディング + テンプレート

1. **オンボーディングA/B**: ペルソナ別スワイプチュートリアル
2. **テンプレート選択**: グリッド表示、テンプレート適用フロー
3. **ディープリンク**: `asterize://template/{id}` でテンプレート適用

---

### Phase 5: サブスクリプション + リリース準備

1. **RevenueCat統合** (iOS/Android課金)
2. **Pricing/Plan Management画面**
3. **アカウント削除機能** (Apple必須要件)
4. **EAS Build設定** + ストアメタデータ
5. **Sentry クラッシュレポーティング**

---

## 4. 既存storage.tsからの移行

### 現在の実装 (`packages/supabase/src/storage.ts`)

```
uploadImage(file, userId, boardId)  → Supabase Storage → publicUrl
deleteImage(imageUrl, userId)       → Supabase Storage remove
isStorageUrl(url)                   → pathname check
```

### 移行後の実装

```
// packages/shared/src/lib/storage.ts（共通インターフェース）
interface StorageService {
  getPresignedUrl(userId, boardId, fileName, contentType): Promise<{ presignedUrl, publicUrl, key }>
  deleteImage(key, userId): Promise<void>
  isStorageUrl(url): boolean
}

// apps/mobile/lib/r2Storage.ts（モバイル実装）
- Worker APIを呼び出してPresigned URL取得
- fetch() でR2に直接PUT

// apps/web/lib/r2Storage.ts（Web実装）
- 同様にWorker API経由
```

### 既存画像のURL互換性
- 既にSupabase Storageに保存された画像URLは引き続きアクセス可能
- 新規アップロードのみR2に向ける
- `isStorageUrl()` を拡張してR2 URLも判定可能に
- 将来的にSupabase Storage → R2に一括移行するスクリプトを用意（Phase 5以降）

---

## 5. 初学者向け 重要注意事項

### セキュリティ必須事項
- 認証トークンは**必ずSecureStore**に保存（AsyncStorage平文保存は危険）
- `SUPABASE_SERVICE_ROLE_KEY` は**絶対にモバイルに含めない**
- **Cloudflare Worker のsecretは `wrangler secret put` で設定**（コードにハードコードしない）
- Presigned URLの有効期限は**最短（5分）**に設定
- 本番ビルドで `console.log` を除去（`babel-plugin-transform-remove-console`）
- Supabase新テーブルは**必ずRLS有効化**
- エラーメッセージは汎用化（生エラーをユーザーに見せない）

### R2固有の注意
- R2バケットは**パブリック読み取り + 認証付き書き込み**で構成
- アップロードは**必ずWorker経由でJWT検証**してからPresigned URL発行
- ファイルパスに**必ずuserIdをプレフィックスとして含める**（認可チェック用）
- 画像URLは**R2カスタムドメイン経由**で配信（`r2.dev` URLはレート制限あり）
- ファイルサイズ制限は**Worker側とモバイル側の両方**でチェック

### パフォーマンス
- 画像アップロード時は**必ずリサイズ**（max 1920px、10MB以下）
- R2のCDNキャッシュを活用（`Cache-Control: public, max-age=31536000`）
- `expo-image` のディスクキャッシュがR2 URLにも適用される
- リスト表示は**FlatListではなくFlashList**を使用
- `renderItem` 内の匿名関数は `useCallback` でメモ化
- `Animated.View` にはNativeWindの `className` が効かない場合あり → `style` propを使用

### コード品質
- ESLintの `react-hooks/exhaustive-deps` を厳密に適用
- `catch (error: any)` → `catch (error: unknown)` + 型ガード
- `useEffect` のcleanup関数を忘れない（メモリリーク防止）
- `app/` ディレクトリにはルートファイルのみ置く（ヘルパーは `lib/` `hooks/` へ）
- 状態管理は**Context API + カスタムフックで十分**（Zustand等不要）

### Expo固有
- ホットリロードで認証状態が消えたら `expo start --clear`
- 新しいネイティブモジュール追加後は `npx expo prebuild --clean`
- `metro.config.js` の `watchFolders` をモノレポ変更時に更新

---

## 6. MVP定義（Phase 0〜2完了時点）

- ボード作成 + キャンバスでの画像/テキスト自由配置
- **Cloudflare R2 経由の画像アップロード・配信**
- フォーカスモードで画像スライドショー + ルーティンチェック
- 彩度変化による視覚フィードバック（モノクロ→カラー）
- オフライン対応（画像ローカルキュー + データキャッシュ + ペンディング同期）
- 5言語対応、ダーク/ライトテーマ
- Supabase認証（SecureStore暗号化保存）

---

## 7. 検証方法

### Phase 0 検証
```bash
# New Architecture起動確認
cd projects/vision-board && pnpm --filter mobile start --clear

# SecureStore: ログイン→アプリ終了→再起動でセッション維持

# R2 Worker動作確認
cd apps/worker && wrangler dev
# curlでPresigned URL取得テスト:
# curl -X POST http://localhost:8787/upload/presign \
#   -H "Authorization: Bearer <jwt>" \
#   -H "Content-Type: application/json" \
#   -d '{"userId":"xxx","boardId":"yyy","fileName":"test.jpg","contentType":"image/jpeg"}'
```

### Phase 1 検証
- 画像10枚以上をR2にアップロードしてパフォーマンス確認
- R2 CDN URLからの画像読み込み速度確認
- 機内モードで画像追加 → ローカル保存 → Wi-Fi復帰後にR2同期確認
- ピンチズーム中にノードドラッグが干渉しないか確認

### Phase 2 検証
- 彩度変化アニメーションが60fps維持か確認
- R2から配信される20枚以上の画像でFlashListスクロール性能
- ルーティンチェック→彩度変化→星加算の一連フロー
