# ページ機能 Step2: ルーティンタブ実装（週次テーブル）

## Context

ページ画面の「ルーティン」タブが `TabPlaceholder` で空状態。penデザイン（`Screen - Routine Edit`）とWeb版 `RoutineWeeklyTable` に従い、**週次テーブル形式**のルーティンUIを実装する。モバイル版 `useRoutines` には `routine_nodes` 中間テーブル対応が欠けているので、同時に拡張する。

---

## penデザイン準拠のUI構造

```
[<]  [今週]  [>]                    ← 週セレクタ

タスク  編集   月  火  水  木  金  土  日
               02  03  04  05  06  07  08
─────────────────────────────────────────
⠿ ● 10kmラン  [✓] [✓] [ ] [ ] [ ] [ ] [ ]   ← 左: grip + 色ドット + 名前
⠿ ● 体幹トレ  [✓] [ ] [✓] [ ] [✓] [ ] [ ]   ← 右: 7日分チェックセル (横スクロール)
─────────────────────────────────────────
＋ 追加...
```

- **左固定列** (width 132): ドラッグハンドル(grip-vertical) + 色ドット(ellipse 15px) + ルーティン名
- **右スクロール列**: 7日分のチェックセル (各52px幅、48px角丸矩形)
- チェック済み: ルーティンカラー背景 + 白checkアイコン
- 未チェック: `#64748B` グレー背景
- 将来日: グレー(`-`表示)
- 色ドットタップ → カラーピッカー（ROUTINE_COLORS 10色）
- タイトルダブルタップ → インライン編集
- 「編集」ボタン → activeDays指定モード

---

## 実装ステップ

### Step 1: useRoutines フック拡張

**変更**: `apps/mobile/hooks/useRoutines.ts`

現状: ボード単位でルーティン取得 + toggleCheck のみ。routine_nodes未対応。

追加内容:
1. **`routineNodes` State** — `useState<RoutineNode[]>([])`
2. **`loadRoutines` 拡張** — `routine_nodes` テーブルもfetch + キャッシュ (`routine_nodes_cache_{boardId}`)
3. **`getRoutinesForNode(nodeId)`** — routine_nodesのsort_orderでソートしてフィルタ
4. **`createRoutine(title, nodeId)`** — routines + routine_nodes INSERT (楽観的更新 + オフラインキュー)
5. **`deleteRoutine(routineId)`** — routines DELETE (CASCADE)
6. **`updateRoutineTitle(routineId, newTitle)`** — routines UPDATE
7. **`updateRoutineColor(routineId, newColor)`** — routines UPDATE
8. **`updateRoutineActiveDays(routineId, activeDays)`** — routines UPDATE
9. **`reorderRoutinesInNode(nodeId, from, to)`** — routine_nodes sort_order 更新
10. **PendingAction型拡張** — `type: 'check' | 'create' | 'delete' | 'update' | 'reorder'`
11. **syncPendingActions** — 新アクションタイプの同期処理

参照: Web版 `packages/supabase/src/hooks/useRoutines.ts` のCRUDロジック

再利用する既存コード:
- `generateId`, `getRandomColor` — `packages/shared/src/lib/utils.ts`
- `getWeekDates`, `getTodayString`, `getDayLabel`, `isRoutineActiveOnDate` — 同上
- `Routine`, `RoutineNode` — `packages/shared/src/lib/pageMapper.ts`
- `ROUTINE_COLORS` — `packages/shared/src/constants/styles.ts`

### Step 2: RoutineWeeklyTable コンポーネント作成

**新規**: `apps/mobile/components/routine/RoutineWeeklyTable.tsx`

penデザインID `BzrnK` の構造に準拠:

```typescript
interface RoutineWeeklyTableProps {
  routines: Routine[];            // getRoutinesForNode() の結果
  weekOffset: number;
  onWeekChange: (offset: number) => void;
  onToggle: (routineId: string, date: string) => void;
  onCreate: (title: string) => void;
  onDelete: (routineId: string) => void;
  onUpdateTitle: (routineId: string, title: string) => void;
  onUpdateColor: (routineId: string, color: string) => void;
  onUpdateActiveDays: (routineId: string, days: number[] | undefined) => void;
  onReorder: (fromIndex: number, toIndex: number) => void;
}
```

UI構成（penデザイン準拠）:
- **WeekSelector**: `[<] [今週] [>]` — weekOffset管理、未来週は`>`無効
- **テーブルヘッダー**: 左=「タスク」「編集」、右=月〜日(曜日+日付)
- **RoutineRow**: 左固定(grip + 色ドット + 名前) + 右スクロール(7セル)
- **AddRow**: `＋ 追加...` テキスト入力
- **ColorPickerModal**: 色ドットタップで表示、ROUTINE_COLORS 10色グリッド
- **ActiveDaysMode**: 「編集」タップで切替、各セルがトグルスイッチに変化

ドラッグ並び替え:
- `react-native-gesture-handler` の `PanGestureHandler` + `reanimated` で実装
- grip-vertical アイコン部分がドラッグハンドル
- ドラッグ中: 半透明 + 影エフェクト
- ドロップ時: `onReorder(fromIndex, toIndex)` コール

テーブルレイアウト実装:
- 左カラム: 固定幅 `View` (width: 132)
- 右カラム: `ScrollView horizontal` (clip: true) で7日分表示
- 各チェックセル: 52px幅フレーム内に48px角丸矩形

色設計（penデザインの色指定に準拠）:
- 背景: `#121212`
- テーブル行背景: `#1E293B60`
- ヘッダーテキスト: `#94A3B8`
- 日付テキスト: `#64748B`
- ルーティン名: `#E2E8F0`
- divider: `#334155`
- 未チェックセル: `#64748B`
- チェック済みセル: ルーティンカラー + 白checkアイコン
- 週ラベル背景: `#6366F1`
- 追加行テキスト: `#595959`

### Step 3: ページ画面統合

**変更**: `apps/mobile/app/(main)/page/[nodeId].tsx`

1. `import { useRoutines }` + `import { RoutineWeeklyTable }`
2. `useRoutines(selectedBoardId, user?.id)` 呼び出し
3. `weekOffset` State追加
4. `getRoutinesForNode(nodeId)` でノード固有ルーティン取得
5. ハンドラー関数: `handleCreate`, `handleReorder` (nodeIdをバインド)
6. `activeTab === 'routine'` の `TabPlaceholder` → `RoutineWeeklyTable` 置換
7. ScrollView構造調整（ルーティンタブ時は内部にテーブルが独自スクロールを持つ）

---

## 変更ファイル一覧

| ファイル | 操作 | 内容 |
|----------|------|------|
| `apps/mobile/hooks/useRoutines.ts` | 変更 | routine_nodes対応、CRUD全操作追加 |
| `apps/mobile/components/routine/RoutineWeeklyTable.tsx` | 新規 | 週次テーブルUI (penデザイン準拠) |
| `apps/mobile/app/(main)/page/[nodeId].tsx` | 変更 | RoutineWeeklyTable統合 |

**新規パッケージ**: なし

---

## 検証方法

1. ページ画面 → ルーティンタブ → 週次テーブル表示（penデザインと一致）
2. `＋ 追加...` → テキスト入力 → Enter → ルーティン追加（ランダムカラー）→ Supabase routines & routine_nodes に保存
3. チェックセルタップ → ルーティンカラーに変化 + ハプティクス + history更新
4. `[<] [>]` → 週移動、`[今週]` → 今週に戻る、未来週は `>` 無効
5. 色ドットタップ → カラーピッカー表示 → 色選択 → 即反映
6. タイトルダブルタップ → インライン編集 → blur/Enter で保存
7. grip-verticalドラッグ → 行並び替え → routine_nodes.sort_order 更新
8. 「編集」タップ → activeDaysモード → 曜日トグル → 保存
9. 機内モード → 上記操作 → オンライン復帰 → 自動同期
