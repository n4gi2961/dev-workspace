# ページ機能 Step1: ナビゲーション・ヘッダー・基本UI

## Context

画像ノードをタップ → NodeToolbarの左端ボタンから「ページ」画面を開く機能。Web版に既存の仕組み（`usePages`, `pageMapper.ts`）を流用してモバイル版を実装する。

スクリーンショットのUI: ヘッダー画像 + タイトル + カテゴリ/年代セレクタ + 3タブ（ルーティン/マイルストーン/データ）

**Step1スコープ**: ナビゲーション遷移 + ヘッダー + タイトル編集 + カテゴリ/年代セレクタ + タブ骨格 + usePages hook

---

## 再利用する既存コード

| リソース | パス | 用途 |
|----------|------|------|
| `pageMapper.ts` | `packages/shared/src/lib/pageMapper.ts` | Page型, pageToSupabase, supabaseToPage, createInitialPage |
| `CATEGORIES`, `DECADES` | `packages/shared/src/constants/ui.ts` | カテゴリ/年代の選択肢 |
| `generateId` | `packages/shared/src/lib/` | UUID生成 |
| `usePages` (Web版) | `packages/supabase/src/hooks/usePages.ts` | ロジック参考（モバイル版を新規作成） |
| `useRoutines` (Web版) | `packages/supabase/src/hooks/useRoutines.ts` | Step3で参考 |

---

## 実装ステップ

### Step 1-1: モバイル版 usePages hook 作成

**新規**: `apps/mobile/hooks/usePages.ts`

- Web版 `usePages.ts` のロジックをモバイル向けに移植
- `createClient` の代わりにモバイルの Supabase クライアントを使用
- AsyncStorageキャッシュは**後回し**（まずSupabase直接通信で動作確認）
- 公開API: `getPage(nodeId)`, `savePage(nodeId, page)`, `saveMilestones(nodeId, milestones)`, `updatePageLocal(nodeId, updates)`

### Step 1-2: ページ画面ルート追加

**新規**: `apps/mobile/app/(main)/page/[nodeId].tsx`

**変更**: `apps/mobile/app/(main)/_layout.tsx`
- `Stack.Screen name="page/[nodeId]"` を追加（`presentation: 'modal'`でフルスクリーンモーダル表示）

**画面構成**（スクリーンショット準拠）:
```
┌──────────────────────────────┐
│ [リフレッシュ] [共有]    [×] │  ← ヘッダー右上アイコン群
│                              │
│  ┌──────────────────────┐    │
│  │   ヘッダー画像        │    │  ← ノードのsrc画像
│  │   「フルマラソン完走」 │    │  ← タイトル（編集可能）
│  └──────────────────────┘    │
│                              │
│  [カテゴリ▼]  [達成年代▼]    │  ← ドロップダウンセレクタ
│                              │
│  [ルーティン] [マイルストーン] [データ]  ← タブ
│                              │
│  （タブ内容 — Step1では空状態）│
│                              │
└──────────────────────────────┘
```

### Step 1-3: NodeToolbar → ページ遷移の接続

**変更**: `apps/mobile/components/canvas/NodeToolbar.tsx`
- 左端の `square-pen` ボタンを画像ノード時に「ページを開く」動作に変更
- `onOpenPage?: (nodeId: string) => void` propを追加

**変更**: `apps/mobile/components/canvas/BoardCanvas.tsx`
- `onOpenPage` propを追加、NodeToolbarに渡す

**変更**: `apps/mobile/app/(main)/(tabs)/index.tsx`
- `handleOpenPage` コールバック追加: `router.push(\`/(main)/page/${nodeId}\`)`
- BoardCanvasに `onOpenPage` を渡す

### Step 1-4: ページ画面UIコンポーネント

**新規**: `apps/mobile/app/(main)/page/[nodeId].tsx` の中身

構成要素:
1. **ヘッダー画像エリア**: expo-imageでノード画像表示 + LinearGradientオーバーレイ
2. **タイトル入力**: TextInput（編集可能、プレースホルダー「タイトルを入力」）
3. **カテゴリセレクタ**: Pressableドロップダウン（place/state/experience）
4. **年代セレクタ**: Pressableドロップダウン（2020s〜2060s）
5. **タブバー**: 3タブ（ルーティン/マイルストーン/データ）— 切り替え可能だが中身はStep2以降
6. **閉じるボタン**: 右上の×で `router.back()`

**データフロー**:
1. 画面マウント時に `usePages.getPage(nodeId)` でページデータ取得
2. タイトル/カテゴリ/年代の変更は `savePage(nodeId, updates)` で保存
3. ページが存在しない場合は `createInitialPage()` で初期データ作成

---

## 変更ファイル一覧

| ファイル | 操作 | 内容 |
|----------|------|------|
| `apps/mobile/hooks/usePages.ts` | 新規 | モバイル版usePagesフック |
| `apps/mobile/app/(main)/page/[nodeId].tsx` | 新規 | ページ画面 |
| `apps/mobile/app/(main)/_layout.tsx` | 変更 | page/[nodeId]ルート追加 |
| `apps/mobile/components/canvas/NodeToolbar.tsx` | 変更 | onOpenPage prop追加、画像ノード用ボタン動作変更 |
| `apps/mobile/components/canvas/BoardCanvas.tsx` | 変更 | onOpenPage prop追加・中継 |
| `apps/mobile/app/(main)/(tabs)/index.tsx` | 変更 | handleOpenPage + router.push |

---

## 検証方法

1. Expo Goで画像ノードをタップ → NodeToolbar表示
2. 左端ボタンタップ → ページ画面にモーダル遷移
3. ヘッダーにノード画像が表示される
4. タイトル入力 → Supabase pagesテーブルに保存される
5. カテゴリ/年代選択 → 保存される
6. ×ボタンでキャンバスに戻る
7. 再度ページを開くと保存したデータが復元される
